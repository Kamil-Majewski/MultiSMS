@{
    ViewData["Title"] = "Home Page";
}

<div class="content-container">
    <div class="tab-content" id="category-tab-content">
        <div class="tab-pane show active" id="send-sms" aria-labelledby="sms-tab">
            <div class="d-flex sms-container">
                Wyślij sms
            </div>
        </div>
        <div class="tab-pane" id="templates">
            <div class="templates-list-container">
                <div class="list-header">
                    <div class="list-header-left">
                        <button class="add-new-button violet-button" type="button" onclick="OpenCreateTemplateWindow()">Dodaj nowy</button>
                    </div>
                    <div class="list-search-bar d-flex">
                        <input class="search-for" placeholder="Wyszukaj szablon" />
                        <button class="search-for-button violet-button" type="button">Wyszukaj</button>
                    </div>
                </div>
                <div class="list-content">
                    <div class="table-responsive">
                        <table class="template-list table table-borderless">
                            <thead>
                                <tr>
                                    <th scope="col">Nazwa</th>
                                    <th scope="col">Opis</th>
                                    <th scope="col">Treść</th>
                                    <th class="centered-cell" scope="col">Opcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="small-cell">Alert RGB</td>
                                    <td class="medium-cell">Alert pogodowy informujący o zagrożeniach atmosferycznych</td>
                                    <td class="big-cell">Dot zdarzenia 56a z sądu okręgowego. Nie wiem co tu wpisać więc będę bełkotał - bla elb ble</td>
                                    <td class="centered-cell">
                                        <a href="#leadMe" class="icon-list"><img src="~/icons/view-doc.png" /></a>
                                        <a href="#leadMe" class="icon-list"><img src="~/icons//edit.png" /></a>
                                        <a href="#leadMe" class="icon-list"><img src="~/icons/trash.png" /></a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="templates-options-container" style="margin:20px;">
                <div class="options-header">
                    <div class="previous-page">
                        <button class="violet-button" id="templates-previous-button" type="button" style="display: flex; align-items:center;" onclick="GoBackToList()">
                            <span style="max-width:24px;"><img src="~/icons/previous.png" /></span>
                            <span>Powrót</span>
                        </button>
                    </div>
                    <div class="option-name">
                        <span class="opion-name-placeholder">Nowy szablon</span>
                    </div>
                </div>
                <div class="list-content">
                    <form class="template-options-form">
                        <div class="form-group">
                            <label for="TemplateName">Nazwa szablonu</label>
                            <input type="text" class="form-input" id="templateNameInput" required />
                        </div>
                        <div class="form-group">
                            <label for="TemplateDescription">Opis</label>
                            <input type="text" class="form-input" id="templateDescriptionInput"  />
                        </div>
                        <div class="form-group">
                            <label for="TemplateContent">Treść wiadomości</label>
                            <textarea class="form-input" id="templateContentInput" rows="5" maxlength="255" required></textarea>
                            <div style="margin-top: 0.25rem; text-align: right" id="symbolCounterAdd">&nbsp</div>
                        </div>
                        <div class="justify-content-center d-flex">
                            <button type="submit" class="violet-button" id="createOrEditButton"></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="tab-pane" id="contacts">
            <div class="d-flex contacts-container">
                kontakty
            </div>
        </div>
        <div class="tab-pane" id="groups">
            <div class="d-flex groups-container">
                grupy
            </div>
        </div>
        <div class="tab-pane" id="roles">
            <div class="d-flex role-container">
                role
            </div>
        </div>
        <div class="tab-pane" id="logs">
            <div class="d-flex logs-container">
                logi
            </div>
        </div>
    </div>
</div>

<script defer>

    function EnableTemplateEditing() {
        $("#templateNameInputEdit").prop('readonly', false);
        $("#templateDescriptionInputEdit").prop('readonly', false);
        $("#templateContentInputEdit").prop('readonly', false);
        $("#editNewTemplateSubmitButton").prop('disabled', false);
        $("#enableTemplateEditing").prop('disabled', true);
    }

    function DeleteTemplate(templateName) {

        $.ajax({
            url: '@Url.Action("DeleteTemplate", "Home")',
            type: 'GET',
            contentType: 'application/json',
            data: { name: templateName},
            success: function (template) {
                console.log("Successfully deleted template")
                FetchAllTemplatesAndPopulateTable();
            },
            error: function (error) {
                console.error(error);
            }
        });
    }

    function EditTemplate() {
        var templateId = $("#templateSelectEdit").val();
        var templateName = $("#templateNameInputEdit").val();
        var templateContent = $("#templateContentInputEdit").val();
        var templateDescription = $("#templateDescriptionInputEdit").val();
        $.ajax({
            url: '@Url.Action("EditTemplate", "Home")',
            type: 'GET',
            contentType: 'application/json',
            data: { id: templateId, name: templateName, description: templateDescription, content: templateContent },
            success: function (template) {
                console.log("Successfully edited template " + template.templateName)
                FetchAllTemplatesAndPopulateSelects();
                
            },
            error: function (error) {
                console.error(error);
            }
        });
    }

    function FetchAllTemplatesAndPopulateTable() {
        $.ajax({
            url: '@Url.Action("FetchAllTemplates", "Home")',
            type: 'GET',
            contentType: 'application/json',
            success: function (listOfTemplates) {
                console.log("Successfully retrieved templates")
                $('.template-list tbody').empty();

                $.each(listOfTemplates, function (index, item) {
                    var newRow = '<tr>' +
                        '<td class="small-cell">' + item.templateName + '</td>' +
                        '<td class="medium-cell">' + item.templateDescription + '</td>' +
                        '<td class="big-cell">' + item.templateContent + '</td>' +
                        '<td class="centered-cell">' +
                        '<a href="#details-' + item.templateName + '" class="icon-list template-details"><img src="/icons/view-doc.png" title="Szczegóły"/></a>' +
                        '<a href="#edit-' + item.templateName + '" class="icon-list template-edit"><img src="/icons/edit.png" title="Edytuj"/></a>' +
                        '<a href="#delete-' + item.templateName + '" class="icon-list template-delete"><img src="/icons/trash.png" title="Usuń"/></a>' +
                        '</td>' +
                        '</tr>';


                    $('.template-list tbody').append(newRow);
                });
                
            },
            error: function (error) {
                console.error(error);
            }
        })
    }

    function GetTemplateByIdAndFillInputFields(id, type){
        $.ajax({
            url: '@Url.Action("GetTemplateById", "Home")',
            type: 'GET',
            contentType: 'application/json',
            data: { id: id },
            success: function (template) {
                let nameInputField = document.getElementById("templateNameInput" + type);
                let descriptionInputField = document.getElementById("templateDescriptionInput" + type);
                let contentInputField = document.getElementById("templateContentInput" + type);

                nameInputField.value = template.templateName;
                descriptionInputField.value = template.templateDescription;
                contentInputField.value = template.templateContent;
            },
            error: function (error) {
                console.error(error);
            }
        });
    }

    function CreateNewTemplate() {
        let name = $("#templateNameInput").val();
        let description = $("#templateDescriptionInput").val();
        let content = $("#templateContentInput").val();

        $.ajax({
            url: '@Url.Action("CreateNewTemplate", "Home")',
            type: 'GET',
            contentType: 'application/json',
            data: { templateName: name, templateDescription: description, templateContent: content },
            success: function (templateEnitity) {
                FetchAllTemplatesAndPopulateTable();
                console.log("Successfully added new template")
            },
            error: function (error) {
                console.error(error);
            }
        });
    }

    function OpenCreateTemplateWindow(){
        $(".template-options-form").attr('id', 'create-template-form');
        $("#createOrEditButton").html("Utwórz");
        $(".templates-list-container").hide();
        $(".templates-options-container").show();
        $("#editTemplateSubmitButton").show();
    }

    function GoBackToList() {
        $(".templates-list-container").show();
        $(".templates-options-container").hide();
        $(".template-options-form").removeAttr('id');
        $(".template-options-form :input").val('');
    }

    $(document).ready(function () {
        
        FetchAllTemplatesAndPopulateTable();

        $(document).on('click', '.template-delete', function (e) {
            var templateName = $(this).attr("href").split('-')[1];
            DeleteTemplate(templateName)
        });

        $(document).on('submit', '#create-template-form', function (e) {
            var form = document.getElementById("create-template-form");
            e.preventDefault();

            if (form.checkValidity() === false) {
                form.reportValidity()
                return
                }

            CreateNewTemplate();
            GoBackToList();
            $(".template-options-form :input").val('');

        });
        // $("#editTemplateForm").hide();
        // $("#deleteTemplateForm").hide();

        // FetchAllTemplatesAndPopulateSelects();

        // let addForm = document.getElementById("createNewTemplateForm");
        // let editForm = document.getElementById("editTemplateForm");
        // let deleteForm = document.getElementById("deleteTemplateForm");

        // addForm.addEventListener('submit', function (event) {
        //     event.preventDefault();

        //     if (addForm.checkValidity() === false) {
        //         addForm.reportValidity()
        //         return
        //     }

        //     CreateNewTemplate();
        // });

        // editForm.addEventListener('submit', function (event) {
        //     event.preventDefault();

        //     if (editForm.checkValidity() === false) {
        //         editForm.reportValidity()
        //         return
        //     }

        //     EditTemplate();
        // });

        // deleteForm.addEventListener('submit', function (event) {
        //     event.preventDefault();

        //     if (editForm.checkValidity() === false) {
        //         editForm.reportValidity()
        //         return
        //     }

        //     DeleteTemplate();
        // });

        // const messageEleForAdd = document.getElementById('templateContentInputAdd');
        // const messageEleForEdit = document.getElementById("templateContentInputEdit");
        
        // messageEleForAdd.addEventListener('input', function (e) {
        //     const target = e.target;
        //     const maxLength = target.getAttribute('maxlength');
        //     const currentLength = target.value.length;
        //     const counterEle = document.getElementById('symbolCounterAdd');
        //     counterEle.innerHTML = `${currentLength}/${maxLength}`;
        // });

        // messageEleForEdit.addEventListener('input', function (e) {
        //     const target = e.target;
        //     const maxLength = target.getAttribute('maxlength');
        //     const currentLength = target.value.length;
        //     const counterEle = document.getElementById('symbolCounterEdit');
        //     counterEle.innerHTML = `${currentLength}/${maxLength}`;
        // });


        // $('#sms-options-list a').on('click', function (e) {
        //     $(".selected-sms").removeClass("selected-sms");
        //     e.preventDefault();
        //     $(this).tab('show');
        //     $(this).parent().toggleClass('selected-sms');
        // });
        // $('#contacts-options-list a').on('click', function (e) {
        //     $(".selected-contacts").removeClass("selected-contacts");
        //     e.preventDefault();
        //     $(this).tab('show');
        //     $(this).parent().toggleClass('selected-contacts');
        // });
        // $('#groups-options-list a').on('click', function (e) {
        //     $(".selected-groups").removeClass("selected-groups");
        //     e.preventDefault();
        //     $(this).tab('show');
        //     $(this).parent().toggleClass('selected-groups');
        // });
        // $('#roles-options-list a').on('click', function (e) {
        //     $(".selected-roles").removeClass("selected-roles");
        //     e.preventDefault();
        //     $(this).tab('show');
        //     $(this).parent().toggleClass('selected-roles');
        // });

        // $("#templateSelectEdit").change(function () {
        //     $("#editTemplateForm").show();
        //     var templateId = $(this).val();
        //     $("#enableTemplateEditing").prop("disabled", false);
        //     GetTemplateByIdAndFillInputFields(templateId, "Edit");
        //     $("#templateNameInputEdit").prop('readonly', true);
        //     $("#templateDescriptionInputEdit").prop('readonly', true);
        //     $("#templateContentInputEdit").prop('readonly', true);
        //     $("#editNewTemplateSubmitButton").prop('disabled', true);
        // });

        // $("#templateSelectDelete").change(function () {
        //     $("#deleteTemplateForm").show();
        //     var templateId = $(this).val();
        //     GetTemplateByIdAndFillInputFields(templateId, "Delete");
        //     $("#deleteTemplateSubmitButton").prop('disabled', false);
        // });
    });


</script>
